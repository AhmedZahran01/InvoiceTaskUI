@{
    Layout = null;
}

<!doctype html>
<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>Create Invoice</title>

    <style>
        .widthCorrect{
            width:80%
        }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(to right, #0575E6, #021B79);
            color: white;
            padding: 30px;
        }

        .container {
            max-width: 1100px;
            margin: auto;
            background: #fff;
            color: #333;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 18px rgba(0,0,0,0.25);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        h2 {
            margin: 0;
            color: #021B79;
        }

        #clock {
            font-size: 18px;
            font-weight: bold;
            color: #0575E6;
            background: #eef4ff;
            padding: 8px 14px;
            border-radius: 8px;
            border: 1px solid #c9d8ff;
        }

        .top-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .group label {
            font-weight: 600;
            color: #021B79;
        }

        input, select {
            width: 100%;
            padding: 8px 10px;
            margin-top: 5px;
            border-radius: 6px;
            border: 1px solid #ddd;
        }

        #invoiceTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: #fafafa;
            border-radius: 8px;
            overflow: hidden;
        }

            #invoiceTable th {
                background: #0575E6;
                color: #fff;
                padding: 10px;
                font-weight: 600;
                text-align: center;
            }

            #invoiceTable td {
                padding: 10px;
                text-align: center;
                border-bottom: 1px solid #ddd;
            }

        #addRow, #saveInvoice {
            padding: 10px 15px;
            background: #0575E6;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 15px;
        }

            #addRow:hover, #saveInvoice:hover {
                background: #021B79;
            }

        .remove {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 8px;
            border-radius: 4px;
            cursor: pointer;
        }

            .remove:hover {
                background: #c0392b;
            }

        .footer {
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #invoiceDiscount {
            width: 120px;
        }
    </style>
</head>

<body>
    <div class="container">

        <!-- ======= HEADER WITH CLOCK ======= -->
        <div class="header">
            <h2>Create Invoice</h2>
            <div id="clock">--:--:--</div>
        </div>

        <!-- -------- NEW TOP SECTION -------- -->
        <div class="top-row">
            <div class="group">
                <label>Invoice No</label>
                <input id="invoiceNo" placeholder="Auto or Manual" />
            </div>

            <div class="group">
                <label>Invoice Date</label>
                <input type="date" id="invoiceDate" />
            </div>

            <div class="group">
                <label>Store</label>
                <select id="store">
                    <option value="1">Main Store</option>
                    <option value="2">Branch 1</option>
                </select>
            </div>
        </div>

        <button id="addRow">+ Add Item</button>

        <table id="invoiceTable" border="1">
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Unit</th>
                    <th>Price</th>
                    <th>Qty</th>
                    <th>Total</th>
                    <th>Discount</th>
                    <th>Net</th>
                    <th></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div class="footer">
            <div>
                <label>Invoice Discount: </label>
                <input id="invoiceDiscount" value="0" />
            </div>

            <button id="saveInvoice">Save Invoice</button>
        </div>

    </div>

    <script>

        // ===================== CLOCK FUNCTION =====================
        function updateClock() {
            const now = new Date();

            const time = now.toLocaleTimeString('en-US', {
                hour12: false
            });

            const date = now.toLocaleDateString('en-GB'); // dd/mm/yyyy

            document.getElementById('clock').innerText = time + " | " + date;
        }

        setInterval(updateClock, 1000);
        updateClock();
        // ============================================================


        const itemsSample = [{ id: 1, name: 'Apple' }, { id: 2, name: 'Orange' }];
        const unitsSample = [{ id: 1, name: 'Kg' }, { id: 2, name: 'Piece' }];

        function newRow() {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><select class="item">${itemsSample.map(i => `<option value="${i.id}">${i.name}</option>`).join('')}</select></td>
                <td><select class="unit">${unitsSample.map(u => `<option value="${u.id}">${u.name}</option>`).join('')}</select></td>
                <td><input class="price widthCorrect" value="0"/></td>
                <td><input class="qty widthCorrect" value="1"/></td>
                <td class="total">0</td>
                <td><input class="discount widthCorrect" value="0"/></td>
                <td class="net">0</td>
                <td><button class="remove">X</button></td>
            `;

            tr.querySelector('.price').addEventListener('input', updateRow);
            tr.querySelector('.qty').addEventListener('input', updateRow);
            tr.querySelector('.discount').addEventListener('input', updateRow);
            tr.querySelector('.remove').addEventListener('click', () => tr.remove());

            document.querySelector('#invoiceTable tbody').appendChild(tr);
            updateRow.call(tr.querySelector('.price'));
        }

        function updateRow() {
            const tr = this.closest('tr');
            const price = parseFloat(tr.querySelector('.price').value || 0);
            const qty = parseFloat(tr.querySelector('.qty').value || 0);
            const discount = parseFloat(tr.querySelector('.discount').value || 0);
            const total = price * qty;

            tr.querySelector('.total').innerText = total.toFixed(2);
            tr.querySelector('.net').innerText = (total - discount).toFixed(2);
        }

        document.getElementById('addRow').addEventListener('click', newRow);

        document.getElementById('saveInvoice').addEventListener('click', async () => {

            const rows = Array.from(document.querySelectorAll('#invoiceTable tbody tr'));
            const itemsDto = rows.map(r => ({
                ItemId: parseInt(r.querySelector('.item').value),
                UnitId: parseInt(r.querySelector('.unit').value),
                Price: parseFloat(r.querySelector('.price').value || 0),
                Quantity: parseFloat(r.querySelector('.qty').value || 0),
                Discount: parseFloat(r.querySelector('.discount').value || 0)
            }));

            const invoiceDiscount = parseFloat(document.getElementById('invoiceDiscount').value || 0);

            try {
                const res = await fetch("https://localhost:7209/api/Invoices/create", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        Items: itemsDto,
                        Discount: invoiceDiscount
                    })
                });

                if (res.ok) {
                    const data = await res.json();
                    alert('Invoice saved with ID: ' + data.id);
                } else {
                    const err = await res.text();
                    alert('Error: ' + err);
                }
            } catch {
                alert('Failed to connect to server.');
            }
        });

        newRow();
    </script>

</body>
</html>
