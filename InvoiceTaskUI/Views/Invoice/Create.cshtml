@{
    Layout = null;
}

<!doctype html>
<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>Create Invoice</title>
</head>
<body>
    <h2>Create Invoice</h2>
    <button id="addRow">Add Item</button>
    <table id="invoiceTable" border="1">
        <thead>
            <tr>
                <th>Item</th>
                <th>Unit</th>
                <th>Price</th>
                <th>Qty</th>
                <th>Total</th>
                <th>Discount</th>
                <th>Net</th>
                <th></th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div>
        <label>Invoice Discount: <input id="invoiceDiscount" value="0" /></label>
        <button id="saveInvoice">Save Invoice</button>
    </div>

    <script>
        const itemsSample = [{ id: 1, name: 'Apple' }, { id: 2, name: 'Orange' }];
        const unitsSample = [{ id: 1, name: 'Kg' }, { id: 2, name: 'Piece' }];

        function newRow() {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><select class="item">${itemsSample.map(i=>`<option value="${i.id}">${i.name}</option>`).join('')}</select></td>
                <td><select class="unit">${unitsSample.map(u=>`<option value="${u.id}">${u.name}</option>`).join('')}</select></td>
                <td><input class="price" value="0"/></td>
                <td><input class="qty" value="1"/></td>
                <td class="total">0</td>
                <td><input class="discount" value="0"/></td>
                <td class="net">0</td>
                <td><button class="remove">X</button></td>
            `;

            tr.querySelector('.price').addEventListener('input', updateRow);
            tr.querySelector('.qty').addEventListener('input', updateRow);
            tr.querySelector('.discount').addEventListener('input', updateRow);
            tr.querySelector('.remove').addEventListener('click', e => tr.remove());

            document.querySelector('#invoiceTable tbody').appendChild(tr);
            updateRow.call(tr.querySelector('.price'));
        }

        function updateRow(e) {
            const tr = this.closest('tr');
            const price = parseFloat(tr.querySelector('.price').value || 0);
            const qty = parseFloat(tr.querySelector('.qty').value || 0);
            const discount = parseFloat(tr.querySelector('.discount').value || 0);
            const total = price * qty;
            tr.querySelector('.total').innerText = total.toFixed(2);
            tr.querySelector('.net').innerText = (total - discount).toFixed(2);
        }

        document.getElementById('addRow').addEventListener('click', newRow);

        document.getElementById('saveInvoice').addEventListener('click', async () => {
            const rows = Array.from(document.querySelectorAll('#invoiceTable tbody tr'));
            const CreateInvoiceItemDto = rows.map(r => ({
                ItemId: parseInt(r.querySelector('.item').value),
                UnitId: parseInt(r.querySelector('.unit').value),
                Price: parseFloat(r.querySelector('.price').value || 0),
                Quantity: parseFloat(r.querySelector('.qty').value || 0),
                Discount: parseFloat(r.querySelector('.discount').value || 0)
            }));

            const invoiceDiscount = parseFloat(document.getElementById('invoiceDiscount').value || 0);

            // get token from localStorage (simple flow) - in real use show login form
            const token = localStorage.getItem('jwt');

            // const res = await fetch('/api/invoices/create', {
            //     method: 'POST',
            //     headers: {
            //         'Content-Type': 'application/json',
            //         'Authorization': token ? `Bearer ${token}` : ''
            //     },
            //            body: JSON.stringify({ Items: items, Discount: invoiceDiscount })
            //         });
        const res = await fetch("http://localhost:5282/api/invoices/create", {
                        method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token ? `Bearer ${token}` : ''
                },
                body: JSON.stringify({ Items: CreateInvoiceItemDto, Discount: invoiceDiscount })
            });

            if (res.ok) {
                const data = await res.json();
                alert('Invoice saved with id: ' + data.id);
            } else if (res.status === 401) {
                alert('Unauthorized. Please login first (use Auth API).');
            } else {
                alert('Error saving invoice');
            }
        });

        // create one row by default
        newRow();
    </script>
</body>
</html>